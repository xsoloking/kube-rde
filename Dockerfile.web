# Build Stage
FROM node:24-alpine AS build

WORKDIR /app

# Copy package.json from web directory
COPY web/package*.json ./
RUN npm install --legacy-peer-deps

# Copy web source code
COPY web/ .
RUN npm run build

# Production Stage
FROM nginx:alpine

# Install envsubst
RUN apk add --no-cache gettext

# Copy built assets
COPY --from=build /app/dist /usr/share/nginx/html

# Copy Nginx config template
COPY web/nginx.conf /etc/nginx/conf.d/default.conf.template

EXPOSE 80

# Default backend URL
ENV BACKEND_URL="http://kuberde-server:8080"

# Substitute env vars and start nginx
CMD ["/bin/sh", "-c", "envsubst '${BACKEND_URL}' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && echo \"window.ENV = { OIDC_AUTHORITY: '${OIDC_AUTHORITY}', OIDC_CLIENT_ID: '${OIDC_CLIENT_ID}' };\" > /usr/share/nginx/html/config.js && nginx -g 'daemon off;'"]
